{% extends "base.html" %}

{% block content %}
<style>
/* åŸæœ‰æ¨£å¼ä¿æŒä¸è®Šï¼Œæ–°å¢æœå°‹ç›¸é—œæ¨£å¼ */
/* è‡ªå®šç¾©æç¤ºæ¡†æ¨£å¼ */
.custom-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    transform: translateX(100%);
    transition: all 0.3s ease;
    max-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.custom-toast.success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.custom-toast.error {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
}

.custom-toast.show {
    transform: translateX(0);
}

.toast-content {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toast-content i {
    font-size: 1.2em;
}

/* æœå°‹æ¡†æ¨£å¼ */
.search-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.search-box {
    position: relative;
}

.search-input {
    border: 2px solid transparent;
    border-radius: 25px;
    padding: 12px 50px 12px 20px;
    font-size: 16px;
    width: 100%;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    background: white;
}

/* æœå°‹æ¡†ç‹€æ…‹æ¨£å¼ */
.search-input:focus {
    outline: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    transform: translateY(-1px);
}

.search-input.search-empty {
    border-color: #e9ecef;
    animation: subtle-pulse 2s infinite;
}

.search-input.search-short {
    border-color: #ffc107;
    background: linear-gradient(90deg, white 95%, #fff3cd 100%);
}

.search-input.search-ready {
    border-color: #28a745;
    background: linear-gradient(90deg, white 95%, #d4edda 100%);
}

/* æœå°‹æŒ‰éˆ•æ¨£å¼ */
.search-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 1;
}

.search-btn:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.search-btn.btn-disabled {
    opacity: 0.5;
    cursor: default;
}

.search-btn.btn-disabled:hover {
    transform: translateY(-50%) scale(1);
    box-shadow: none;
}

/* å‹•ç•«æ•ˆæœ */
@keyframes subtle-pulse {
    0%, 100% { 
        border-color: #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    50% { 
        border-color: #dee2e6;
        box-shadow: 0 2px 15px rgba(0,0,0,0.15);
    }
}

@keyframes focus-glow {
    0%, 100% {
        box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }
    50% {
        box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
    }
}

.search-input.search-ready {
    animation: none;
}

.search-input.search-ready:focus {
    animation: focus-glow 2s infinite;
}

.search-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 15px;
}

.suggestion-tag {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.suggestion-tag:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
}

/* æœå°‹çµæœæ¨£å¼ */
.search-results-header {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.clear-search-btn {
    background: none;
    border: 1px solid #6c757d;
    color: #6c757d;
    border-radius: 20px;
    padding: 5px 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.clear-search-btn:hover {
    background: #6c757d;
    color: white;
}

/* è¼‰å…¥å‹•ç•« */
.search-loading {
    display: none;
    text-align: center;
    padding: 40px;
}

.search-loading .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æœå°‹æç¤ºæ–‡å­—å‹•æ…‹æ•ˆæœ */
.search-input::placeholder {
    transition: color 0.3s ease;
}

.search-input.search-empty::placeholder {
    color: #6c757d;
}

.search-input.search-short::placeholder {
    color: #856404;
}

.search-input.search-ready::placeholder {
    color: #155724;
}

/* å…¶ä»–åŸæœ‰æ¨£å¼ä¿æŒä¸è®Š */
.tag-weight-badge {
    position: relative;
    overflow: hidden;
}

.tag-weight-badge::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
}

.tag-weight-badge.new-update::after {
    left: 100%;
}

#user-tags-container {
    transition: all 0.3s ease;
}

#user-tags-container.updated {
    background-color: rgba(40, 167, 69, 0.1);
    border-radius: 8px;
    padding: 8px;
    border: 2px solid rgba(40, 167, 69, 0.3);
}

.clickable-tag {
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
    position: relative;
}

.clickable-tag:hover {
    background-color: #007bff !important;
    color: white !important;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

.clickable-tag.updating {
    pointer-events: none;
    opacity: 0.7;
}

.clickable-tag::after {
    content: 'ğŸ‘†';
    position: absolute;
    top: -8px;
    right: -8px;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.clickable-tag:hover::after {
    opacity: 1;
}

.stat-item {
    transition: all 0.3s ease;
}

.stat-item.updated {
    background-color: rgba(40, 167, 69, 0.1) !important;
    transform: scale(1.02);
}

.tags-hint {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.tags-hint i {
    color: #ffc107;
}
</style>

<div class="row">
    <!-- ç”¨æˆ¶é¸æ“‡å’Œæª”æ¡ˆå€åŸŸ -->
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-user me-2"></i>ç”¨æˆ¶é¸æ“‡</h5>
            </div>
            <div class="card-body">
                <form method="GET">
                    <div class="mb-3">
                        <select name="user_id" class="form-select" onchange="this.form.submit()">
                            <option value="">è«‹é¸æ“‡ç”¨æˆ¶</option>
                            {% for user in user_list %}
                            <option value="{{ user }}" {% if user == selected_user %}selected{% endif %}>
                                {{ user[:8] }}...
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
        </div>

        {% if user_profile %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user-circle me-2"></i>ç”¨æˆ¶æª”æ¡ˆ</h5>
            </div>
            <div class="card-body" id="user-profile-content">
                <div class="user-stats">
                    <div class="stat-item">
                        <i class="fas fa-dollar-sign text-success"></i>
                        <span>å¹³å‡æ¶ˆè²»: ${{ "{:,.0f}".format(user_profile.average_price) }}</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-eye text-info"></i>
                        <span>ç€è¦½å•†å“: {{ user_profile.total_viewed }}å€‹</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-globe text-primary"></i>
                        <span>{{ user_profile.preference_type }}</span>
                    </div>
                </div>

                {% if user_profile.top_tags %}
                <div class="mt-3">
                    <h6>
                        åå¥½æ¨™ç±¤:
                        <small class="text-muted">(é»æ“Šå•†å“æ¨™ç±¤å¢åŠ æ¬Šé‡)</small>
                    </h6>
                    <div class="tags-hint">
                        <i class="fas fa-lightbulb"></i>
                        <span>æ¬Šé‡æ•¸å­—è¶Šé«˜ä»£è¡¨æ‚¨è¶Šå–œæ­¡è©²é¡å‹</span>
                    </div>
                    <div class="tags-container" id="user-tags-container">
                        {% for tag_info in user_profile.top_tags %}
                        <span class="badge bg-secondary me-1 mb-1 tag-weight-badge" 
                              id="user-tag-{{ loop.index }}">
                            {{ tag_info.tag }} ({{ tag_info.weight }})
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- æ¨è–¦çµæœå€åŸŸ -->
    <div class="col-md-9">
        <!-- æœå°‹åŠŸèƒ½å€å¡Š -->
        <div class="search-container">
            <h5 class="text-white mb-3">
                <i class="fas fa-search me-2"></i>æœå°‹æ—…éŠè¡Œç¨‹
            </h5>
            <div class="search-box">
                <input type="text" 
                       class="search-input search-empty" 
                       id="searchInput" 
                       placeholder="è¼¸å…¥é—œéµè©æœå°‹ï¼Œä¾‹å¦‚ï¼šæº«æ³‰ã€æ—¥æœ¬ã€è¦ªå­æ—…éŠ..."
                       onkeypress="handleSearchKeyPress(event)"
                       oninput="handleSearchInput(this)">
                <button class="search-btn btn-disabled" 
                        id="searchBtn"
                        onclick="handleSearchClick()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="search-suggestions">
                <span class="text-white-50 me-2">ç†±é–€æœå°‹ï¼š</span>
                <span class="suggestion-tag" onclick="quickSearch('æº«æ³‰')">æº«æ³‰</span>
                <span class="suggestion-tag" onclick="quickSearch('æ—¥æœ¬')">æ—¥æœ¬</span>
                <span class="suggestion-tag" onclick="quickSearch('è¦ªå­')">è¦ªå­</span>
                <span class="suggestion-tag" onclick="quickSearch('ç¾é£Ÿ')">ç¾é£Ÿ</span>
                <span class="suggestion-tag" onclick="quickSearch('æ–‡åŒ–')">æ–‡åŒ–</span>
                <span class="suggestion-tag" onclick="quickSearch('è‡ªç„¶æ™¯è§€')">è‡ªç„¶æ™¯è§€</span>
            </div>
        </div>

        <!-- æœå°‹çµæœæ¨™é¡Œ -->
        <div id="search-results-header" class="search-results-header" style="display: none;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-search me-2"></i>
                        æœå°‹çµæœï¼š<span id="search-query-display"></span>
                    </h6>
                    <small class="text-muted">æ‰¾åˆ° <span id="search-results-count">0</span> å€‹ç›¸é—œè¡Œç¨‹</small>
                </div>
                <button class="clear-search-btn" onclick="clearSearch()">
                    <i class="fas fa-times me-1"></i>æ¸…é™¤æœå°‹
                </button>
            </div>
        </div>

        <!-- è¼‰å…¥å‹•ç•« -->
        <div id="search-loading" class="search-loading">
            <div class="spinner"></div>
            <p class="text-muted">æ­£åœ¨æœå°‹ä¸­...</p>
        </div>

        <!-- æ¨è–¦æ¨™é¡Œ -->
        <div class="d-flex justify-content-between align-items-center mb-4" id="recommendation-header">
            <h2><i class="fas fa-star text-warning me-2"></i>ç‚ºæ‚¨æ¨è–¦</h2>
            {% if selected_user %}
            <button class="btn btn-outline-primary btn-sm" onclick="refreshRecommendations()">
                <i class="fas fa-sync-alt me-1"></i>é‡æ–°æ¨è–¦
            </button>
            {% endif %}
        </div>

        {% if selected_user %}
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="info-alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>æç¤ºï¼š</strong>é»æ“Šæ¨è–¦å•†å“ä¸‹æ–¹çš„æ¨™ç±¤å¯ä»¥å¢åŠ è©²æ¨™ç±¤çš„åå¥½æ¬Šé‡ï¼Œå¹«åŠ©ç³»çµ±ç‚ºæ‚¨æä¾›æ›´ç²¾æº–çš„æ¨è–¦ï¼
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if recommendations %}
        <div class="row" id="recommendations-container">
            {% for rec in recommendations %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card recommendation-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div class="method-badge">
                            {% if 'content' in rec.method %}
                            <span class="badge bg-info">å…§å®¹æ¨è–¦</span>
                            {% endif %}
                            {% if 'collaborative' in rec.method %}
                            <span class="badge bg-success">å”åŒéæ¿¾</span>
                            {% endif %}
                            {% if 'tag' in rec.method %}
                            <span class="badge bg-warning">æ¨™ç±¤åŒ¹é…</span>
                            {% endif %}
                        </div>
                        <div class="score-badge">
                            <span class="badge bg-primary">{{ "%.2f"|format(rec.score) }}</span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title" title="{{ rec.product_name }}">
                            {{ rec.product_name[:50] }}
                            {% if rec.product_name|length > 50 %}...{% endif %}
                        </h5>
                        
                        <div class="price-tag mb-3">
                            <i class="fas fa-tag me-1"></i>
                            <strong>NT$ {{ "{:,.0f}".format(rec.price) }}</strong>
                        </div>

                        {% if rec.activity_tags %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-running me-1"></i>æ´»å‹•æ¨™ç±¤:
                            </small>
                            <div class="tags-container">
                                {% for tag in rec.activity_tags.split(';')[:3] %}
                                {% if tag.strip() %}
                                <span class="badge bg-light text-dark me-1 mb-1 clickable-tag" 
                                      data-tag="{{ tag.strip() }}" 
                                      data-user="{{ selected_user }}"
                                      onclick="handleTagClick(this)"
                                      title="é»æ“Šå¢åŠ  '{{ tag.strip() }}' æ¨™ç±¤åå¥½æ¬Šé‡">
                                    {{ tag.strip() }}
                                </span>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if rec.location_tags %}
                        <div class="mb-3">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>åœ°é»æ¨™ç±¤:
                            </small>
                            <div class="tags-container">
                                {% for tag in rec.location_tags.split(';')[:3] %}
                                {% if tag.strip() %}
                                <span class="badge bg-light text-dark me-1 mb-1 clickable-tag" 
                                      data-tag="{{ tag.strip() }}" 
                                      data-user="{{ selected_user }}"
                                      onclick="handleTagClick(this)"
                                      title="é»æ“Šå¢åŠ  '{{ tag.strip() }}' æ¨™ç±¤åå¥½æ¬Šé‡">
                                    {{ tag.strip() }}
                                </span>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="recommendation-reason">
                            <i class="fas fa-lightbulb text-warning me-1"></i>
                            <small class="text-muted">{{ rec.reason }}</small>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        {% if rec.link %}
                        <a href="{{ rec.link }}" target="_blank" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹è©³æƒ…
                        </a>
                        {% else %}
                        <button class="btn btn-secondary btn-sm w-100" disabled>
                            æš«ç„¡é€£çµ
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5" id="no-results">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">æš«ç„¡æ¨è–¦çµæœ</h4>
            <p class="text-muted">è«‹é¸æ“‡ä¸€å€‹ç”¨æˆ¶ä¾†æŸ¥çœ‹å€‹äººåŒ–æ¨è–¦</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// å…¨åŸŸè®Šæ•¸
let currentSearchQuery = '';
let isSearchMode = false;

// æœå°‹è¼¸å…¥è™•ç† - æ–°å¢å³æ™‚åé¥‹
function handleSearchInput(inputElement) {
    const query = inputElement.value;
    const searchBtn = document.getElementById('searchBtn');
    
    // æ¸…é™¤æ‰€æœ‰ç‹€æ…‹é¡åˆ¥
    inputElement.classList.remove('search-empty', 'search-short', 'search-ready');
    searchBtn.classList.remove('btn-disabled');
    
    if (query.length === 0) {
        // ç©ºç™½ç‹€æ…‹
        inputElement.classList.add('search-empty');
        searchBtn.classList.add('btn-disabled');
        updateSearchPlaceholder(inputElement, 'é–‹å§‹è¼¸å…¥ä¾†æœå°‹è¡Œç¨‹...');
    } else if (query.length === 1) {
        // è¼¸å…¥éçŸ­ç‹€æ…‹
        inputElement.classList.add('search-short');
        updateSearchPlaceholder(inputElement, 'å†è¼¸å…¥ä¸€äº›å­—ç¬¦æœƒæ›´ç²¾æº–å“¦');
    } else {
        // æº–å‚™å°±ç·’ç‹€æ…‹
        inputElement.classList.add('search-ready');
        updateSearchPlaceholder(inputElement, 'æŒ‰ Enter æˆ–é»æ“Šæœå°‹');
    }
}

// æ›´æ–° placeholder æ–‡å­—
function updateSearchPlaceholder(inputElement, newPlaceholder) {
    inputElement.setAttribute('placeholder', newPlaceholder);
}

// æœå°‹æŒ‰éˆ•é»æ“Šè™•ç†
function handleSearchClick() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput.value.trim();
    
    if (query.length === 0) {
        // ç©ºç™½æœå°‹ï¼šèšç„¦åˆ°æœå°‹æ¡†ä¸¦è¼•å¾®å‹•ç•«æç¤º
        searchInput.focus();
        searchInput.style.animation = 'subtle-pulse 1s ease-in-out';
        setTimeout(() => {
            searchInput.style.animation = '';
        }, 1000);
        return;
    }
    
    // åŸ·è¡Œæœå°‹
    performSearch();
}

// éµç›¤äº‹ä»¶è™•ç†
function handleSearchKeyPress(event) {
    if (event.key === 'Enter') {
        const query = event.target.value.trim();
        if (query.length === 0) {
            // ç©ºç™½æŒ‰ Enterï¼šè¼•å¾®æç¤º
            event.target.style.animation = 'subtle-pulse 1s ease-in-out';
            setTimeout(() => {
                event.target.style.animation = '';
            }, 1000);
            return;
        }
        performSearch();
    }
}

// åŸ·è¡Œæœå°‹ - ç§»é™¤éŒ¯èª¤æª¢æŸ¥
async function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const query = searchInput.value.trim();
    
    // ä¸å†æª¢æŸ¥ç©ºç™½æˆ–é•·åº¦ï¼Œç›´æ¥è™•ç†
    currentSearchQuery = query || '';
    isSearchMode = true;
    
    // å¦‚æœæ˜¯ç©ºç™½æœå°‹ï¼Œé¡¯ç¤ºæ‰€æœ‰çµæœ
    if (!query) {
        // å¯ä»¥é¸æ“‡å›åˆ°æ¨è–¦æ¨¡å¼æˆ–æœå°‹æ‰€æœ‰
        clearSearch();
        return;
    }
    
    // è¦–è¦ºåé¥‹ï¼šæœå°‹æ¡†ç¢ºèªç‹€æ…‹
    searchInput.classList.remove('search-empty', 'search-short');
    searchInput.classList.add('search-ready');
    
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    showSearchLoading(true);
    
    // éš±è—æ¨è–¦çµæœ
    document.getElementById('recommendations-container').style.display = 'none';
    document.getElementById('recommendation-header').style.display = 'none';
    document.getElementById('info-alert')?.style.setProperty('display', 'none');
    
    try {
        const userId = '{{ selected_user }}';
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                user_id: userId || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displaySearchResults(data.results, data.query, data.total);
        } else {
            throw new Error(data.error || 'æœå°‹å¤±æ•—');
        }
        
    } catch (error) {
        console.error('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        // æ”¹ç‚ºæº«å’Œçš„è™•ç†æ–¹å¼ï¼Œä¸è·³å‡ºéŒ¯èª¤è¨Šæ¯
        showSearchLoading(false);
        displaySearchResults([], query, 0);
    }
}

function quickSearch(keyword) {
    const searchInput = document.getElementById('searchInput');
    searchInput.value = keyword;
    
    // è§¸ç™¼è¼¸å…¥äº‹ä»¶ä¾†æ›´æ–°ç‹€æ…‹
    handleSearchInput(searchInput);
    
    // çŸ­æš«å»¶é²å¾ŒåŸ·è¡Œæœå°‹ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ç‹€æ…‹è®ŠåŒ–
    setTimeout(() => {
        performSearch();
    }, 200);
}

function displaySearchResults(results, query, total) {
    showSearchLoading(false);
    
    // é¡¯ç¤ºæœå°‹çµæœæ¨™é¡Œ
    const headerElement = document.getElementById('search-results-header');
    const queryDisplay = document.getElementById('search-query-display');
    const countDisplay = document.getElementById('search-results-count');
    
    queryDisplay.textContent = query;
    countDisplay.textContent = total;
    headerElement.style.display = 'block';
    
    // é¡¯ç¤ºæœå°‹çµæœ
    const container = document.getElementById('recommendations-container');
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">æ‰¾ä¸åˆ°ç›¸é—œçµæœ</h4>
                <p class="text-muted">è«‹å˜—è©¦å…¶ä»–é—œéµè©æˆ–ä½¿ç”¨æ¨è–¦åŠŸèƒ½</p>
                <button class="btn btn-primary" onclick="clearSearch()">æŸ¥çœ‹æ¨è–¦</button>
            </div>
        `;
    } else {
        container.innerHTML = results.map(result => createProductCard(result)).join('');
        
        // é‡æ–°åˆå§‹åŒ–æ¨™ç±¤é»æ“ŠåŠŸèƒ½
        initializeClickableTags();
    }
    
    container.style.display = 'flex';
}

function createProductCard(product) {
    const activityTags = product.activity_tags ? product.activity_tags.split(';').slice(0, 3) : [];
    const locationTags = product.location_tags ? product.location_tags.split(';').slice(0, 3) : [];
    const selectedUser = '{{ selected_user }}';
    
    return `
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card recommendation-card h-100">
                <div class="card-header d-flex justify-content-between align-items-start">
                    <div class="method-badge">
                        <span class="badge bg-primary">æœå°‹çµæœ</span>
                    </div>
                    <div class="score-badge">
                        <span class="badge bg-success">${product.score.toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="card-body">
                    <h5 class="card-title" title="${product.product_name}">
                        ${product.product_name.length > 50 ? product.product_name.substring(0, 50) + '...' : product.product_name}
                    </h5>
                    
                    <div class="price-tag mb-3">
                        <i class="fas fa-tag me-1"></i>
                        <strong>NT$ ${product.price.toLocaleString()}</strong>
                    </div>

                    ${activityTags.length > 0 ? `
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-running me-1"></i>æ´»å‹•æ¨™ç±¤:
                        </small>
                        <div class="tags-container">
                            ${activityTags.map(tag => tag.trim() ? `
                                <span class="badge bg-light text-dark me-1 mb-1 clickable-tag" 
                                      data-tag="${tag.trim()}" 
                                      data-user="${selectedUser}"
                                      onclick="handleTagClick(this)"
                                      title="é»æ“Šå¢åŠ  '${tag.trim()}' æ¨™ç±¤åå¥½æ¬Šé‡">
                                    ${tag.trim()}
                                </span>
                            ` : '').join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${locationTags.length > 0 ? `
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i>åœ°é»æ¨™ç±¤:
                        </small>
                        <div class="tags-container">
                            ${locationTags.map(tag => tag.trim() ? `
                                <span class="badge bg-light text-dark me-1 mb-1 clickable-tag" 
                                      data-tag="${tag.trim()}" 
                                      data-user="${selectedUser}"
                                      onclick="handleTagClick(this)"
                                      title="é»æ“Šå¢åŠ  '${tag.trim()}' æ¨™ç±¤åå¥½æ¬Šé‡">
                                    ${tag.trim()}
                                </span>
                            ` : '').join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div class="recommendation-reason">
                        <i class="fas fa-lightbulb text-warning me-1"></i>
                        <small class="text-muted">${product.reason}</small>
                    </div>
                </div>
                
                <div class="card-footer">
                    ${product.link ? `
                    <a href="${product.link}" target="_blank" class="btn btn-primary btn-sm w-100">
                        <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹è©³æƒ…
                    </a>
                    ` : `
                    <button class="btn btn-secondary btn-sm w-100" disabled>
                        æš«ç„¡é€£çµ
                    </button>
                    `}
                </div>
            </div>
        </div>
    `;
}

function clearSearch() {
    // æ¸…é™¤æœå°‹ç‹€æ…‹
    currentSearchQuery = '';
    isSearchMode = false;
    
    // æ¸…é™¤æœå°‹æ¡†ä¸¦é‡ç½®ç‹€æ…‹
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    
    searchInput.value = '';
    searchInput.classList.remove('search-short', 'search-ready');
    searchInput.classList.add('search-empty');
    searchBtn.classList.add('btn-disabled');
    updateSearchPlaceholder(searchInput, 'è¼¸å…¥é—œéµè©æœå°‹ï¼Œä¾‹å¦‚ï¼šæº«æ³‰ã€æ—¥æœ¬ã€è¦ªå­æ—…éŠ...');
    
    // éš±è—æœå°‹çµæœæ¨™é¡Œ
    document.getElementById('search-results-header').style.display = 'none';
    
    // é¡¯ç¤ºæ¨è–¦æ¨™é¡Œå’Œæç¤º
    document.getElementById('recommendation-header').style.display = 'flex';
    const infoAlert = document.getElementById('info-alert');
    if (infoAlert) {
        infoAlert.style.display = 'block';
    }
    
    // é‡æ–°è¼‰å…¥æ¨è–¦çµæœ
    refreshRecommendations();
}

function showSearchLoading(show) {
    const loadingElement = document.getElementById('search-loading');
    if (show) {
        loadingElement.style.display = 'block';
    } else {
        loadingElement.style.display = 'none';
    }
}

function initializeClickableTags() {
    document.querySelectorAll('.clickable-tag').forEach((tag, index) => {
        const tagText = tag.getAttribute('data-tag');
        tag.setAttribute('title', `é»æ“Šå¢åŠ  "${tagText}" æ¨™ç±¤çš„åå¥½æ¬Šé‡`);
    });
}

// åŸæœ‰çš„æ¨™ç±¤é»æ“ŠåŠŸèƒ½ä¿æŒä¸è®Š
async function handleTagClick(element) {
    const tag = element.getAttribute('data-tag');
    const userId = element.getAttribute('data-user');
    
    console.log(`é»æ“Šæ¨™ç±¤: ${tag}, ç”¨æˆ¶: ${userId}`);
    
    if (!tag || !userId) {
        console.error('ç¼ºå°‘å¿…è¦åƒæ•¸');
        showErrorMessage('ç¼ºå°‘å¿…è¦åƒæ•¸');
        return;
    }
    
    // é˜²æ­¢é‡è¤‡é»æ“Š
    if (element.classList.contains('updating')) {
        console.log('æ­£åœ¨æ›´æ–°ä¸­ï¼Œå¿½ç•¥é‡è¤‡é»æ“Š');
        return;
    }
    
    element.classList.add('updating');
    
    // è¦–è¦ºåé¥‹ï¼šæ·»åŠ é»æ“Šæ•ˆæœ
    const originalStyle = {
        transform: element.style.transform,
        opacity: element.style.opacity,
        backgroundColor: element.style.backgroundColor,
        color: element.style.color,
        border: element.style.border
    };
    
    element.style.transform = 'scale(0.95)';
    element.style.opacity = '0.7';
    
    try {
        console.log(`æ­£åœ¨ç™¼é€è«‹æ±‚æ›´æ–°æ¨™ç±¤: ${tag}`);
        
        const response = await fetch('/api/update_tag', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                tag: tag
            })
        });
        
        console.log('æ”¶åˆ°éŸ¿æ‡‰ï¼Œç‹€æ…‹:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('æœå‹™å™¨éŸ¿æ‡‰æ•¸æ“š:', data);
        
        if (data.success) {
            // é¡¯ç¤ºæˆåŠŸæç¤º
            showSuccessMessage(data.message || `æ¨™ç±¤ "${tag}" æ¬Šé‡å·²å¢åŠ `);
            
            // æ›´æ–°ç”¨æˆ¶æª”æ¡ˆé¡¯ç¤º
            if (data.user_profile) {
                console.log('æ­£åœ¨æ›´æ–°ç”¨æˆ¶æª”æ¡ˆ...');
                updateUserProfile(data.user_profile);
            } else {
                console.warn('æœå‹™å™¨éŸ¿æ‡‰ä¸­ç¼ºå°‘ user_profile æ•¸æ“š');
            }
            
            // æ·»åŠ æˆåŠŸçš„è¦–è¦ºæ•ˆæœ
            element.style.backgroundColor = '#28a745';
            element.style.color = 'white';
            element.style.border = '2px solid #1e7e34';
            element.style.transform = 'scale(1.1)';
            element.style.opacity = '1';
            
            // 1.5ç§’å¾Œæ¢å¾©åŸç‹€
            setTimeout(() => {
                element.style.transform = originalStyle.transform;
                element.style.opacity = originalStyle.opacity;
                element.style.backgroundColor = originalStyle.backgroundColor;
                element.style.color = originalStyle.color;
                element.style.border = originalStyle.border;
                element.classList.remove('updating');
            }, 1500);
            
        } else {
            throw new Error(data.error || 'æ›´æ–°å¤±æ•—');
        }
        
    } catch (error) {
        console.error('æ›´æ–°æ¨™ç±¤æ¬Šé‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        
        // æ¢å¾©åŸç‹€
        element.style.transform = originalStyle.transform;
        element.style.opacity = originalStyle.opacity;
        element.style.backgroundColor = originalStyle.backgroundColor;
        element.style.color = originalStyle.color;
        element.style.border = originalStyle.border;
        element.classList.remove('updating');
        
        // é¡¯ç¤ºéŒ¯èª¤
        showErrorMessage('æ›´æ–°å¤±æ•—: ' + error.message);
    }
}

// é¡¯ç¤ºæˆåŠŸè¨Šæ¯
function showSuccessMessage(message) {
    console.log('é¡¯ç¤ºæˆåŠŸè¨Šæ¯:', message);
    const toast = createToast(message, 'success');
    document.body.appendChild(toast);
    
    // é¡¯ç¤ºå‹•ç•«
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // 3ç§’å¾Œç§»é™¤
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
function showErrorMessage(message) {
    console.log('é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯:', message);
    const toast = createToast(message, 'error');
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 4000);
}

// å‰µå»ºæç¤ºæ¡†
function createToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `custom-toast ${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
            <span>${message}</span>
        </div>
    `;
    return toast;
}

// æ›´æ–°ç”¨æˆ¶æª”æ¡ˆé¡¯ç¤º - å®Œæ•´ç‰ˆ
function updateUserProfile(userProfile) {
    console.log('é–‹å§‹æ›´æ–°ç”¨æˆ¶æª”æ¡ˆ:', userProfile);
    
    // æ›´æ–°æ¨™ç±¤å®¹å™¨
    const tagsContainer = document.getElementById('user-tags-container');
    if (tagsContainer && userProfile.top_tags && userProfile.top_tags.length > 0) {
        console.log('æ›´æ–°æ¨™ç±¤å®¹å™¨...');
        
        // æ·»åŠ æ›´æ–°å‹•ç•«
        tagsContainer.style.opacity = '0.5';
        tagsContainer.style.transform = 'scale(0.95)';
        
        setTimeout(() => {
            let tagsHtml = '';
            userProfile.top_tags.forEach((tagInfo, index) => {
                tagsHtml += `<span class="badge bg-secondary me-1 mb-1 tag-weight-badge" 
                    id="user-tag-${index + 1}">
                    ${tagInfo.tag} (${tagInfo.weight})
                </span>`;
            });
            tagsContainer.innerHTML = tagsHtml;
            
            // æ¢å¾©å‹•ç•«
            tagsContainer.style.opacity = '1';
            tagsContainer.style.transform = 'scale(1)';
            
            // æ·»åŠ é–ƒçˆæ•ˆæœ
            tagsContainer.classList.add('updated');
            setTimeout(() => {
                tagsContainer.classList.remove('updated');
            }, 1000);
            
            console.log('æ¨™ç±¤å®¹å™¨æ›´æ–°å®Œæˆ');
            
        }, 200);
    } else {
        console.warn('æ‰¾ä¸åˆ°æ¨™ç±¤å®¹å™¨æˆ–æ²’æœ‰æ¨™ç±¤æ•¸æ“š');
    }
    
    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
    updateUserStats(userProfile);
}

// æ›´æ–°ç”¨æˆ¶çµ±è¨ˆè³‡è¨Š
function updateUserStats(userProfile) {
    console.log('æ›´æ–°ç”¨æˆ¶çµ±è¨ˆè³‡è¨Š...');
    
    // æ›´æ–°å¹³å‡æ¶ˆè²»
    const avgPriceElement = document.querySelector('.stat-item:nth-child(1) span');
    if (avgPriceElement && userProfile.average_price !== undefined) {
        const newText = `å¹³å‡æ¶ˆè²»: ${userProfile.average_price.toLocaleString()}`;
        if (avgPriceElement.textContent !== newText) {
            avgPriceElement.textContent = newText;
            avgPriceElement.parentElement.classList.add('updated');
            setTimeout(() => {
                avgPriceElement.parentElement.classList.remove('updated');
            }, 1000);
        }
    }
    
    // æ›´æ–°ç€è¦½å•†å“æ•¸
    const viewedElement = document.querySelector('.stat-item:nth-child(2) span');
    if (viewedElement && userProfile.total_viewed !== undefined) {
        const newText = `ç€è¦½å•†å“: ${userProfile.total_viewed}å€‹`;
        if (viewedElement.textContent !== newText) {
            viewedElement.textContent = newText;
            viewedElement.parentElement.classList.add('updated');
            setTimeout(() => {
                viewedElement.parentElement.classList.remove('updated');
            }, 1000);
        }
    }
    
    // æ›´æ–°åå¥½é¡å‹
    const preferenceElement = document.querySelector('.stat-item:nth-child(3) span');
    if (preferenceElement && userProfile.preference_type) {
        if (preferenceElement.textContent !== userProfile.preference_type) {
            preferenceElement.textContent = userProfile.preference_type;
            preferenceElement.parentElement.classList.add('updated');
            setTimeout(() => {
                preferenceElement.parentElement.classList.remove('updated');
            }, 1000);
        }
    }
}

// é‡æ–°è¼‰å…¥æ¨è–¦
function refreshRecommendations() {
    console.log('é‡æ–°è¼‰å…¥æ¨è–¦...');
    location.reload();
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('é é¢è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–åŠŸèƒ½...');
    
    // åˆå§‹åŒ–å¯é»æ“Šæ¨™ç±¤
    initializeClickableTags();
    
    // åˆå§‹åŒ–æœå°‹æ¡†ç‹€æ…‹
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    if (searchInput && searchBtn) {
        // è¨­å®šåˆå§‹ç‹€æ…‹
        searchInput.classList.add('search-empty');
        searchBtn.classList.add('btn-disabled');
        
        // æ·»åŠ ç„¦é»è™•ç†
        searchInput.addEventListener('focus', function() {
            this.parentElement.style.transform = 'scale(1.02)';
        });
        
        searchInput.addEventListener('blur', function() {
            this.parentElement.style.transform = 'scale(1)';
        });
    }
    
    // é¡¯ç¤ºåˆå§‹åŒ–å®Œæˆè¨Šæ¯
    const tagCount = document.querySelectorAll('.clickable-tag').length;
    console.log(`æ¨™ç±¤é»æ“ŠåŠŸèƒ½å·²åˆå§‹åŒ–ï¼Œå…± ${tagCount} å€‹å¯é»æ“Šæ¨™ç±¤`);
    
    // å¦‚æœæœ‰é¸ä¸­çš„ç”¨æˆ¶ï¼Œé¡¯ç¤ºæ­¡è¿è¨Šæ¯
    const selectedUser = '{{ selected_user }}';
    if (selectedUser) {
        console.log(`ç•¶å‰ç”¨æˆ¶: ${selectedUser}`);
    }
});
</script>
{% endblock %}