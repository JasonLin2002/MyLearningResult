<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雄獅旅遊 - 行程推薦</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header_v2lion pge_conl" data-template-kind="header" data-pc-fix="true" data-pc-fix-start="false" data-header-title data-simple-pcheader="false" data-mobile-menu="false" data-home-icon="false" data-header-visibility data-toggle-search="true" data-toggle-info165="true" data-mobile-fix="true" data-mobile-fix-start="false" data-mobile-top-transparent="false" data-mobile-bg-white="false" data-mobile-changeColor-height data-mobile-langcurrency-top="false">
        <div class="header_v2lion_inner">
            <div class="header_top">
                <div class="logo">
                    <a href="https://www.liontravel.com/category/zh-tw/index">
                        <img src="./img/favicon.jpg" alt="雄獅旅遊">
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="#">國外團體</a></li>
                        <li><a href="#">機票</a></li>
                        <li><a href="#">訂房</a></li>
                        <li><a href="#">自由行</a></li>
                        <li><a href="#">票券當地遊</a></li>
                        <!-- 新增登入區域 -->
                        <li class="login-section">
                            <input type="text" 
                                   id="userIdInput" 
                                   placeholder="輸入 User ID..." 
                                   class="user-id-input">
                            <button onclick="handleLogin()" class="login-btn">登入</button>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="header_bottom">
                <h1></h1>
                <p></p>
            </div>
        </div>
    </header>

    <div class="search-container">
        <div class="search-box">
            <input type="text" placeholder="搜尋行程...">
            <button>搜尋</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-options">
            <label for="destination">目的地：</label>
            <select id="destination">
                <option value="">不限</option>
                <option value="日本">日本</option>
                <option value="韓國">韓國</option>
                <option value="泰國">泰國</option>
                <option value="歐洲">歐洲</option>
            </select>
        </div>
        <div class="filter-options">
            <label for="price-range">價格範圍：</label>
            <select id="price-range">
                <option value="">不限</option>
                <option value="0-50000">NT$ 0 - 50,000</option>
                <option value="50000-100000">NT$ 50,000 - 100,000</option>
                <option value="100000-">NT$ 100,000 以上</option>
            </select>
        </div>
        <div class="sort-options">
            <label for="sort-by">排序方式：</label>
            <select id="sort-by">
                <option value="default">預設</option>
                <option value="price-asc">價格（由低到高）</option>
                <option value="price-desc">價格（由高到低）</option>
                <option value="popularity">熱門程度</option>
            </select>
        </div>
    </div>

    <main>
        <!-- 新增專屬推薦區域 -->
        <div class="recommendation-section">
            <div class="recommendation-header">
                <h2>🌟 專屬推薦</h2>
                <p>根據您的喜好為您精選的優質行程</p>
            </div>
            <div class="recommendation-grid">
                <!-- 推薦商品卡片將會由 JavaScript 動態載入 -->
            </div>
        </div>

        <div class="product-grid">
            <!-- 行程卡片將會由 JavaScript 動態載入 -->
        </div>
    </main>

    <div class="pagination-controls" style="text-align: center; margin-top: 20px;">
        <button id="prev-page" disabled>上一頁</button>
        <span id="page-info"></span>
        <button id="next-page" disabled>下一頁</button>
    </div>

    <footer>
        <p>&copy; 2025 仿製介面</p>
    </footer>

    <script>
        const productGrid = document.querySelector('.product-grid');
        const recommendationGrid = document.querySelector('.recommendation-grid');
        const searchInput = document.querySelector('.search-box input[type="text"]');
        const sortBySelect = document.getElementById('sort-by');
        const destinationSelect = document.getElementById('destination');
        const priceRangeSelect = document.getElementById('price-range');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');

        const itemsPerPage = 28;
        let currentPage = 1;
        let allProducts = [];
        let currentProductList = [];
        let totalPages = 1;

        const imageDir = './img/product-grid/';
        const defaultImage = 'https://www.liontravel.com/cto/view/default4-3.jpg';

        let currentUserId = null;

        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        async function updateUserTagWeight(tag) {
            if (!currentUserId) return;
            
            try {
                console.log(`正在更新標籤權重: ${tag} for user: ${currentUserId}`);
                
                const response = await fetch('/api/update_tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        tag: tag
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('標籤權重更新響應:', data);
                
                if (data.success) {
                    console.log(`標籤 "${tag}" 權重已成功更新`);
                    loadRecommendedProducts();
                } else {
                    console.error('更新標籤權重失敗:', data.error);
                }
                
            } catch (error) {
                console.error('更新標籤權重時發生錯誤:', error);
                console.log('回退到本地存儲方式');
                const storageKey = 'user_tags_' + currentUserId;
                let userTags = {};
                try {
                    const raw = localStorage.getItem(storageKey);
                    if (raw) userTags = JSON.parse(raw);
                } catch (e) {}
                if (userTags[tag]) {
                    userTags[tag] += 1;
                } else {
                    userTags[tag] = 1;
                }
                localStorage.setItem(storageKey, JSON.stringify(userTags));
                loadRecommendedProducts();
            }
        }

        async function loadUserTags(userId) {
            try {
                const response = await fetch(`/api/user/${userId}/tags`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('從後端API載入用戶標籤:', data.user_tags);
                    return data.user_tags;
                }
            } catch (error) {
                console.warn('後端API載入用戶標籤失敗，嘗試其他方式:', error);
            }

            const storageKey = 'user_tags_' + userId;
            try {
                const raw = localStorage.getItem(storageKey);
                if (raw) {
                    const tags = JSON.parse(raw);
                    if (tags && Object.keys(tags).length > 0) {
                        console.log('從localStorage載入用戶標籤:', tags);
                        return tags;
                    }
                }
            } catch (e) {
                console.warn('localStorage載入失敗:', e);
            }

            try {
                const response = await fetch('../data/users.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const userData = await response.json();
                if (userData.user_analysis && userData.user_analysis[userId] && userData.user_analysis[userId].user_tags) {
                    console.log('從users.json載入用戶標籤:', userData.user_analysis[userId].user_tags);
                    return userData.user_analysis[userId].user_tags;
                }
                return null;
            } catch (error) {
                console.error('載入使用者標籤時發生錯誤:', error);
                return null;
            }
        }

        function getRecommendedProductsByTags(userTags, allProducts) {
            if (!userTags || Object.keys(userTags).length === 0) {
                console.log('使用者無標籤資料，使用預設推薦');
                return allProducts.slice(0, 6);
            }

            const sortedTags = Object.entries(userTags)
                .sort(([,weightA], [,weightB]) => weightB - weightA);

            console.log('排序後的使用者標籤:', sortedTags);

            const recommendedProducts = [];
            const usedProductIds = new Set();

            if (sortedTags.length > 0) {
                const topTag = sortedTags[0][0];
                const topTagProducts = findProductsByTag(topTag, allProducts, usedProductIds, 3);
                recommendedProducts.push(...topTagProducts);
                console.log(`最高權重標籤 "${topTag}": 找到 ${topTagProducts.length} 個商品`);
            }

            for (let i = 1; i < sortedTags.length && recommendedProducts.length < 6; i++) {
                const tag = sortedTags[i][0];
                const tagProducts = findProductsByTag(tag, allProducts, usedProductIds, 1);
                recommendedProducts.push(...tagProducts);
                console.log(`標籤 "${tag}": 找到 ${tagProducts.length} 個商品`);
            }

            if (recommendedProducts.length < 6) {
                const remaining = 6 - recommendedProducts.length;
                const defaultProducts = allProducts
                    .filter(product => !usedProductIds.has(product.ProductIDFromFile))
                    .slice(0, remaining);
                recommendedProducts.push(...defaultProducts);
                console.log(`用預設商品補足 ${defaultProducts.length} 個`);
            }

            return recommendedProducts.slice(0, 6);
        }

        function findProductsByTag(tag, allProducts, usedProductIds, maxCount) {
            const matchedProducts = allProducts.filter(product => {
                if (usedProductIds.has(product.ProductIDFromFile)) {
                    return false;
                }

                const searchFields = [
                    product.ProdName || '',
                    product.tags || '',
                    ...(product.activityTags || []),
                    ...(product.locationTags || [])
                ];

                return searchFields.some(field => 
                    field.toLowerCase().includes(tag.toLowerCase())
                );
            });

            const selectedProducts = matchedProducts.slice(0, maxCount);
            selectedProducts.forEach(product => {
                usedProductIds.add(product.ProductIDFromFile);
            });

            return selectedProducts;
        }

        async function getRecommendedProductIds() {
            if (!currentUserId) {
                console.log('無使用者 ID，使用預設推薦');
                return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
            }

            try {
                console.log('嘗試使用後端推薦API...');
                const response = await fetch(`/api/recommend/${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('從後端API獲取推薦:', data);
                    if (data.recommendations && data.recommendations.length > 0) {
                        const productIds = data.recommendations.map(item => item.product_id || item.ProductIDFromFile);
                        console.log('後端推薦的產品ID:', productIds);
                        return productIds;
                    }
                }
            } catch (error) {
                console.warn('後端推薦API調用失敗，使用前端邏輯:', error);
            }

            try {
                const userTags = await loadUserTags(currentUserId);
                if (!userTags) {
                    console.log('使用者標籤載入失敗，使用預設推薦');
                    return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
                }

                const recommendedProducts = getRecommendedProductsByTags(userTags, allProducts);
                return recommendedProducts.map(product => product.ProductIDFromFile);
            } catch (error) {
                console.error('獲取推薦商品時發生錯誤:', error);
                return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
            }
        }

        async function loadRecommendedProducts() {
            try {
                console.log('正在載入推薦商品...');
                if (currentUserId) {
                    console.log('使用者 ID:', currentUserId);
                }
                
                const recommendedIds = await getRecommendedProductIds();
                console.log('獲得推薦 ID:', recommendedIds);
                
                if (allProducts.length > 0) {
                    const recommendedProducts = getProductsByIds(recommendedIds, allProducts);
                    console.log('找到推薦商品:', recommendedProducts.length, '個');
                    displayRecommendedProducts(recommendedProducts);
                } else {
                    console.warn('allProducts 尚未載入，稍後重試推薦商品載入');
                }
            } catch (error) {
                console.error('載入推薦商品時發生錯誤:', error);
                recommendationGrid.innerHTML = '<p>載入推薦商品時發生錯誤</p>';
            }
        }

        function sanitizeFilenameComponent(idComponent) {
            if (!idComponent) return `invalid_id_component_${Math.floor(Math.random() * 9000) + 1000}`;
            let safeId = String(idComponent).replace(/[\\/*?:"<>|]/g, "_");
            safeId = safeId.replace(/^\.+|\.+$/g, '').trim();
            return safeId || `invalid_id_component_${Math.floor(Math.random() * 9000) + 1000}`;
        }

        function displayProducts(productsToShow) {
            productGrid.innerHTML = '';
            if (!productsToShow || productsToShow.length === 0) {
                productGrid.innerHTML = '<p>沒有找到符合條件的行程。</p>';
                return;
            }
            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');

                const productLink = document.createElement('a');
                productLink.href = product.referer || '#';
                productLink.target = '_blank';

                const productImg = document.createElement('img');
                const safeProductId = sanitizeFilenameComponent(product.ProductIDFromFile);
                const imageUrl = `${imageDir}${safeProductId}.jpg`;
                productImg.src = imageUrl;
                productImg.alt = product.ProdName;
                productImg.onerror = function() {
                    this.src = defaultImage;
                    console.warn(`無法載入圖片: ${imageUrl} (基於product_id ${product.ProductIDFromFile}), 使用預設圖片。`);
                };

                const productTitle = document.createElement('h2');
                productTitle.textContent = product.ProdName;

                const bottomRowContainer = document.createElement('div');
                bottomRowContainer.classList.add('product-bottom-row');

                const tagsContainer = document.createElement('div');
                tagsContainer.classList.add('product-tags');

                if (product.activityTags && Array.isArray(product.activityTags) && product.activityTags.length > 0) {
                    const activityRow = document.createElement('div');
                    activityRow.classList.add('tag-row');
                    
                    product.activityTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'activity-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        activityRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(activityRow);
                }

                if (product.locationTags && Array.isArray(product.locationTags) && product.locationTags.length > 0) {
                    const locationRow = document.createElement('div');
                    locationRow.classList.add('tag-row');
                    
                    product.locationTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'location-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        locationRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(locationRow);
                }
                bottomRowContainer.appendChild(tagsContainer);

                const productPrice = document.createElement('p');
                productPrice.classList.add('price');
                const price = typeof product.ProdPrice === 'number' ? product.ProdPrice.toLocaleString() : 'price未知';
                productPrice.textContent = `NT$ ${price} 起`;
                bottomRowContainer.appendChild(productPrice);

                productLink.appendChild(productImg);
                productLink.appendChild(productTitle);
                productLink.appendChild(bottomRowContainer); 
                productCard.appendChild(productLink);
                productGrid.appendChild(productCard);
            });
        }

        function updatePagination(totalItems) {
            totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 0) totalPages = 1; 
            pageInfo.textContent = `頁 ${currentPage} / ${totalPages}`;

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalItems === 0;
        }

        function renderPage(pageNumber) {
            currentPage = pageNumber;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = currentProductList.slice(startIndex, endIndex);

            displayProducts(paginatedItems);
            updatePagination(currentProductList.length);
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const sortBy = sortBySelect.value;
            const selectedDestination = destinationSelect.value; 
            const selectedPriceRange = priceRangeSelect.value; 

            let filteredProducts = allProducts.filter(product => {
                let searchMatch = false;
                if (searchTerm) {
                    const nameMatch = product.ProdName && product.ProdName.toLowerCase().includes(searchTerm);
                    const activityMatch = product.activityType && product.activityType.toLowerCase().includes(searchTerm);
                    const locationMatch = product.locationAttraction && product.locationAttraction.toLowerCase().includes(searchTerm);
                    const tagMatch = product.tags && product.tags.toLowerCase().includes(searchTerm);
                    const activityTagsMatch = product.activityTags && product.activityTags.some(tag => 
                        tag.toLowerCase().includes(searchTerm)
                    );
                    const locationTagsMatch = product.locationTags && product.locationTags.some(tag => 
                        tag.toLowerCase().includes(searchTerm)
                    );
                    searchMatch = nameMatch || activityMatch || locationMatch || tagMatch || activityTagsMatch || locationTagsMatch;
                } else {
                    searchMatch = true;
                }

                const destinationMatch = !selectedDestination || 
                    (product.ProdName && product.ProdName.toLowerCase().includes(selectedDestination.toLowerCase())) || 
                    (product.locationAttraction && product.locationAttraction.toLowerCase().includes(selectedDestination.toLowerCase())) ||
                    (product.locationTags && product.locationTags.some(tag => 
                        tag.toLowerCase().includes(selectedDestination.toLowerCase())
                    ));
                
                const price = product.ProdPrice || 0; 
                let priceMatch = true; 
                if (selectedPriceRange) {
                    if (selectedPriceRange === '0-50000') {
                        priceMatch = price >= 0 && price <= 50000;
                    } else if (selectedPriceRange === '50000-100000') {
                        priceMatch = price > 50000 && price <= 100000;
                    } else if (selectedPriceRange === '100000-') {
                        priceMatch = price > 100000;
                    }
                }
                return searchMatch && destinationMatch && priceMatch; 
            });

            let sortedProducts = [...filteredProducts]; 
            switch (sortBy) {
                case 'price-asc':
                    sortedProducts.sort((a, b) => (a.ProdPrice || 0) - (b.ProdPrice || 0));
                    break;
                case 'price-desc':
                    sortedProducts.sort((a, b) => (b.ProdPrice || 0) - (a.ProdPrice || 0));
                    break;
                case 'default':
                default:
                    break;
            }

            currentProductList = sortedProducts; 
            renderPage(1); 
        }

        function parseCSVLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim());
            return result;
        }

        function getProductsByIds(productIds, productList) {
            return productIds.map(id => {
                return productList.find(product => product.ProductIDFromFile === id);
            }).filter(product => product !== undefined);
        }

        function displayRecommendedProducts(products) {
            recommendationGrid.innerHTML = '';
            if (!products || products.length === 0) {
                recommendationGrid.innerHTML = '<p>暫無推薦商品</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card', 'recommended-card');

                const productLink = document.createElement('a');
                productLink.href = product.referer || '#';
                productLink.target = '_blank';

                const productImg = document.createElement('img');
                const safeProductId = sanitizeFilenameComponent(product.ProductIDFromFile);
                const imageUrl = `${imageDir}${safeProductId}.jpg`;
                productImg.src = imageUrl;
                productImg.alt = product.ProdName;
                productImg.onerror = function() {
                    this.src = defaultImage;
                    console.warn(`無法載入圖片: ${imageUrl} (基於product_id ${product.ProductIDFromFile}), 使用預設圖片。`);
                };

                const productTitle = document.createElement('h2');
                productTitle.textContent = product.ProdName;

                const bottomRowContainer = document.createElement('div');
                bottomRowContainer.classList.add('product-bottom-row');

                const tagsContainer = document.createElement('div');
                tagsContainer.classList.add('product-tags');

                if (product.activityTags && Array.isArray(product.activityTags) && product.activityTags.length > 0) {
                    const activityRow = document.createElement('div');
                    activityRow.classList.add('tag-row');
                    
                    product.activityTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'activity-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        activityRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(activityRow);
                }

                if (product.locationTags && Array.isArray(product.locationTags) && product.locationTags.length > 0) {
                    const locationRow = document.createElement('div');
                    locationRow.classList.add('tag-row');
                    
                    product.locationTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'location-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        locationRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(locationRow);
                }
                bottomRowContainer.appendChild(tagsContainer);

                const productPrice = document.createElement('p');
                productPrice.classList.add('price');
                const price = typeof product.ProdPrice === 'number' ? product.ProdPrice.toLocaleString() : 'price未知';
                productPrice.textContent = `NT$ ${price} 起`;
                bottomRowContainer.appendChild(productPrice);

                productLink.appendChild(productImg);
                productLink.appendChild(productTitle);
                productLink.appendChild(bottomRowContainer); 
                productCard.appendChild(productLink);
                recommendationGrid.appendChild(productCard);
            });
        }

        fetch('../data/products.csv')
            .then(response => {
                if (!response.ok) {
                    console.error('Fetch response not OK:', response);
                    throw new Error(`HTTP error! status: ${response.status}. Could not fetch CSV.`);
                }
                return response.text(); 
            })
            .then(csvText => {
                const productMap = new Map();
                const lines = csvText.trim().split(/\r\n|\n/); 

                if (lines.length < 2) {
                    console.warn('CSV file is empty or has no data rows.');
                    allProducts = [];
                    currentProductList = [];
                    renderPage(1);
                    return;
                }

                const headers = parseCSVLine(lines[0]);
                const prodNameIndex = headers.indexOf('product_name');
                const prodPriceIndex = headers.indexOf('price');
                const productIdCsvIndex = headers.indexOf('product_id');
                const activityTagsIndex = headers.indexOf('activity_tags');
                const locationTagsIndex = headers.indexOf('location_tags');

                if (prodNameIndex === -1 || prodPriceIndex === -1 || productIdCsvIndex === -1) {
                    console.error('Required columns (product_name, price, product_id) not found in CSV headers. Found headers:', headers);
                    productGrid.innerHTML = `<p>CSV 檔案格式錯誤，缺少必要的欄位表頭 (product_name, price, product_id)。</p>`;
                    return;
                }
                if (activityTagsIndex === -1) console.warn("CSV header 'activity_tags' not found. Activity tag functionality might be limited.");
                if (locationTagsIndex === -1) console.warn("CSV header 'location_tags' not found. Location tag functionality might be limited.");

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue; 
                    const cells = parseCSVLine(lines[i]);

                    if (cells.length < headers.length) {
                        console.warn(`Skipping malformed CSV line ${i+1}: ${lines[i]}`);
                        continue;
                    }

                    const prodName = cells[prodNameIndex];
                    const prodPriceStr = cells[prodPriceIndex];
                    const productIdFromFile = cells[productIdCsvIndex];
                    
                    const activityTags = activityTagsIndex !== -1 ? (cells[activityTagsIndex] || '') : '';
                    const locationTags = locationTagsIndex !== -1 ? (cells[locationTagsIndex] || '') : '';
                    
                    const activityTagsArray = activityTags ? activityTags.split(';').map(tag => tag.trim()).filter(tag => tag) : [];
                    const locationTagsArray = locationTags ? locationTags.split(';').map(tag => tag.trim()).filter(tag => tag) : [];
                    
                    const displayActivityTags = activityTagsArray.slice(0, 4);
                    const displayLocationTags = locationTagsArray.slice(0, 4);
                    
                    const allTagsForSearch = [...activityTagsArray, ...locationTagsArray].join(', ');

                    const prodPrice = parseFloat(prodPriceStr);

                    if (prodName &&
                        prodName.length >= 15 && 
                        !isNaN(prodPrice) &&     
                        prodPrice !== undefined &&
                        productIdFromFile && 
                        !productMap.has(prodName)) { 
                        productMap.set(prodName, {
                            ProductIDFromFile: productIdFromFile,
                            ProdName: prodName,
                            ProdPrice: prodPrice,
                            referer: '#',
                            tags: allTagsForSearch,
                            activityTags: displayActivityTags,
                            locationTags: displayLocationTags,
                            activityType: '',
                            locationAttraction: ''
                        });
                    }
                }

                allProducts = Array.from(productMap.values());
                currentProductList = [...allProducts];

                renderPage(1);

                const urlUserId = getUserIdFromUrl();
                if (urlUserId) {
                    currentUserId = urlUserId;
                    console.log('從 URL 獲取使用者 ID:', currentUserId);
                    const userIdInput = document.getElementById('userIdInput');
                    if (userIdInput) {
                        userIdInput.value = currentUserId;
                    }
                }

                loadRecommendedProducts();

                searchInput.addEventListener('input', applyFiltersAndSort);
                sortBySelect.addEventListener('change', applyFiltersAndSort);
                destinationSelect.addEventListener('change', applyFiltersAndSort);
                priceRangeSelect.addEventListener('change', applyFiltersAndSort);

                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        renderPage(currentPage - 1);
                    }
                });

                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        renderPage(currentPage + 1);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading or processing products from CSV:', error);
                productGrid.innerHTML = `<p>載入行程時發生錯誤，請檢查 CSV 檔案是否存在或格式是否正確。</p>`;
                prevButton.disabled = true;
                nextButton.disabled = true;
                pageInfo.textContent = '錯誤';
            });

        function handleLogin() {
            const userIdInput = document.getElementById('userIdInput');
            const userId = userIdInput.value.trim();
            
            if (!userId) {
                alert('請輸入 User ID');
                return;
            }
            
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(userId)) {
                alert('請輸入有效的 User ID 格式');
                return;
            }
            
            currentUserId = userId;
            console.log('登入成功，使用者 ID:', currentUserId);
            
            loadRecommendedProducts();
            
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('user_id', userId);
            window.history.pushState({}, '', newUrl);
            
            alert('登入成功！正在為您載入個人化推薦商品...');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userIdInput = document.getElementById('userIdInput');
            if (userIdInput) {
                userIdInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });
    </script>
</body>
</html>