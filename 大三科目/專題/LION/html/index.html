<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›„ç…æ—…éŠ - è¡Œç¨‹æ¨è–¦</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header_v2lion pge_conl" data-template-kind="header" data-pc-fix="true" data-pc-fix-start="false" data-header-title data-simple-pcheader="false" data-mobile-menu="false" data-home-icon="false" data-header-visibility data-toggle-search="true" data-toggle-info165="true" data-mobile-fix="true" data-mobile-fix-start="false" data-mobile-top-transparent="false" data-mobile-bg-white="false" data-mobile-changeColor-height data-mobile-langcurrency-top="false">
        <div class="header_v2lion_inner">
            <div class="header_top">
                <div class="logo">
                    <a href="https://www.liontravel.com/category/zh-tw/index">
                        <img src="./img/favicon.jpg" alt="é›„ç…æ—…éŠ">
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="#">åœ‹å¤–åœ˜é«”</a></li>
                        <li><a href="#">æ©Ÿç¥¨</a></li>
                        <li><a href="#">è¨‚æˆ¿</a></li>
                        <li><a href="#">è‡ªç”±è¡Œ</a></li>
                        <li><a href="#">ç¥¨åˆ¸ç•¶åœ°éŠ</a></li>
                        <!-- æ–°å¢ç™»å…¥å€åŸŸ -->
                        <li class="login-section">
                            <input type="text" 
                                   id="userIdInput" 
                                   placeholder="è¼¸å…¥ User ID..." 
                                   class="user-id-input">
                            <button onclick="handleLogin()" class="login-btn">ç™»å…¥</button>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="header_bottom">
                <h1></h1>
                <p></p>
            </div>
        </div>
    </header>

    <div class="search-container">
        <div class="search-box">
            <input type="text" placeholder="æœå°‹è¡Œç¨‹...">
            <button>æœå°‹</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-options">
            <label for="destination">ç›®çš„åœ°ï¼š</label>
            <select id="destination">
                <option value="">ä¸é™</option>
                <option value="æ—¥æœ¬">æ—¥æœ¬</option>
                <option value="éŸ“åœ‹">éŸ“åœ‹</option>
                <option value="æ³°åœ‹">æ³°åœ‹</option>
                <option value="æ­æ´²">æ­æ´²</option>
            </select>
        </div>
        <div class="filter-options">
            <label for="price-range">åƒ¹æ ¼ç¯„åœï¼š</label>
            <select id="price-range">
                <option value="">ä¸é™</option>
                <option value="0-50000">NT$ 0 - 50,000</option>
                <option value="50000-100000">NT$ 50,000 - 100,000</option>
                <option value="100000-">NT$ 100,000 ä»¥ä¸Š</option>
            </select>
        </div>
        <div class="sort-options">
            <label for="sort-by">æ’åºæ–¹å¼ï¼š</label>
            <select id="sort-by">
                <option value="default">é è¨­</option>
                <option value="price-asc">åƒ¹æ ¼ï¼ˆç”±ä½åˆ°é«˜ï¼‰</option>
                <option value="price-desc">åƒ¹æ ¼ï¼ˆç”±é«˜åˆ°ä½ï¼‰</option>
                <option value="popularity">ç†±é–€ç¨‹åº¦</option>
            </select>
        </div>
    </div>

    <main>
        <!-- æ–°å¢å°ˆå±¬æ¨è–¦å€åŸŸ -->
        <div class="recommendation-section">
            <div class="recommendation-header">
                <h2>ğŸŒŸ å°ˆå±¬æ¨è–¦</h2>
                <p>æ ¹æ“šæ‚¨çš„å–œå¥½ç‚ºæ‚¨ç²¾é¸çš„å„ªè³ªè¡Œç¨‹</p>
            </div>
            <div class="recommendation-grid">
                <!-- æ¨è–¦å•†å“å¡ç‰‡å°‡æœƒç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>

        <div class="product-grid">
            <!-- è¡Œç¨‹å¡ç‰‡å°‡æœƒç”± JavaScript å‹•æ…‹è¼‰å…¥ -->
        </div>
    </main>

    <div class="pagination-controls" style="text-align: center; margin-top: 20px;">
        <button id="prev-page" disabled>ä¸Šä¸€é </button>
        <span id="page-info"></span>
        <button id="next-page" disabled>ä¸‹ä¸€é </button>
    </div>

    <footer>
        <p>&copy; 2025 ä»¿è£½ä»‹é¢</p>
    </footer>

    <script>
        const productGrid = document.querySelector('.product-grid');
        const recommendationGrid = document.querySelector('.recommendation-grid');
        const searchInput = document.querySelector('.search-box input[type="text"]');
        const sortBySelect = document.getElementById('sort-by');
        const destinationSelect = document.getElementById('destination');
        const priceRangeSelect = document.getElementById('price-range');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const pageInfo = document.getElementById('page-info');

        const itemsPerPage = 28;
        let currentPage = 1;
        let allProducts = [];
        let currentProductList = [];
        let totalPages = 1;

        const imageDir = './img/product-grid/';
        const defaultImage = 'https://www.liontravel.com/cto/view/default4-3.jpg';

        let currentUserId = null;

        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        async function updateUserTagWeight(tag) {
            if (!currentUserId) return;
            
            try {
                console.log(`æ­£åœ¨æ›´æ–°æ¨™ç±¤æ¬Šé‡: ${tag} for user: ${currentUserId}`);
                
                const response = await fetch('/api/update_tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        tag: tag
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('æ¨™ç±¤æ¬Šé‡æ›´æ–°éŸ¿æ‡‰:', data);
                
                if (data.success) {
                    console.log(`æ¨™ç±¤ "${tag}" æ¬Šé‡å·²æˆåŠŸæ›´æ–°`);
                    loadRecommendedProducts();
                } else {
                    console.error('æ›´æ–°æ¨™ç±¤æ¬Šé‡å¤±æ•—:', data.error);
                }
                
            } catch (error) {
                console.error('æ›´æ–°æ¨™ç±¤æ¬Šé‡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                console.log('å›é€€åˆ°æœ¬åœ°å­˜å„²æ–¹å¼');
                const storageKey = 'user_tags_' + currentUserId;
                let userTags = {};
                try {
                    const raw = localStorage.getItem(storageKey);
                    if (raw) userTags = JSON.parse(raw);
                } catch (e) {}
                if (userTags[tag]) {
                    userTags[tag] += 1;
                } else {
                    userTags[tag] = 1;
                }
                localStorage.setItem(storageKey, JSON.stringify(userTags));
                loadRecommendedProducts();
            }
        }

        async function loadUserTags(userId) {
            try {
                const response = await fetch(`/api/user/${userId}/tags`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('å¾å¾Œç«¯APIè¼‰å…¥ç”¨æˆ¶æ¨™ç±¤:', data.user_tags);
                    return data.user_tags;
                }
            } catch (error) {
                console.warn('å¾Œç«¯APIè¼‰å…¥ç”¨æˆ¶æ¨™ç±¤å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ–¹å¼:', error);
            }

            const storageKey = 'user_tags_' + userId;
            try {
                const raw = localStorage.getItem(storageKey);
                if (raw) {
                    const tags = JSON.parse(raw);
                    if (tags && Object.keys(tags).length > 0) {
                        console.log('å¾localStorageè¼‰å…¥ç”¨æˆ¶æ¨™ç±¤:', tags);
                        return tags;
                    }
                }
            } catch (e) {
                console.warn('localStorageè¼‰å…¥å¤±æ•—:', e);
            }

            try {
                const response = await fetch('../data/users.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const userData = await response.json();
                if (userData.user_analysis && userData.user_analysis[userId] && userData.user_analysis[userId].user_tags) {
                    console.log('å¾users.jsonè¼‰å…¥ç”¨æˆ¶æ¨™ç±¤:', userData.user_analysis[userId].user_tags);
                    return userData.user_analysis[userId].user_tags;
                }
                return null;
            } catch (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…æ¨™ç±¤æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return null;
            }
        }

        function getRecommendedProductsByTags(userTags, allProducts) {
            if (!userTags || Object.keys(userTags).length === 0) {
                console.log('ä½¿ç”¨è€…ç„¡æ¨™ç±¤è³‡æ–™ï¼Œä½¿ç”¨é è¨­æ¨è–¦');
                return allProducts.slice(0, 6);
            }

            const sortedTags = Object.entries(userTags)
                .sort(([,weightA], [,weightB]) => weightB - weightA);

            console.log('æ’åºå¾Œçš„ä½¿ç”¨è€…æ¨™ç±¤:', sortedTags);

            const recommendedProducts = [];
            const usedProductIds = new Set();

            if (sortedTags.length > 0) {
                const topTag = sortedTags[0][0];
                const topTagProducts = findProductsByTag(topTag, allProducts, usedProductIds, 3);
                recommendedProducts.push(...topTagProducts);
                console.log(`æœ€é«˜æ¬Šé‡æ¨™ç±¤ "${topTag}": æ‰¾åˆ° ${topTagProducts.length} å€‹å•†å“`);
            }

            for (let i = 1; i < sortedTags.length && recommendedProducts.length < 6; i++) {
                const tag = sortedTags[i][0];
                const tagProducts = findProductsByTag(tag, allProducts, usedProductIds, 1);
                recommendedProducts.push(...tagProducts);
                console.log(`æ¨™ç±¤ "${tag}": æ‰¾åˆ° ${tagProducts.length} å€‹å•†å“`);
            }

            if (recommendedProducts.length < 6) {
                const remaining = 6 - recommendedProducts.length;
                const defaultProducts = allProducts
                    .filter(product => !usedProductIds.has(product.ProductIDFromFile))
                    .slice(0, remaining);
                recommendedProducts.push(...defaultProducts);
                console.log(`ç”¨é è¨­å•†å“è£œè¶³ ${defaultProducts.length} å€‹`);
            }

            return recommendedProducts.slice(0, 6);
        }

        function findProductsByTag(tag, allProducts, usedProductIds, maxCount) {
            const matchedProducts = allProducts.filter(product => {
                if (usedProductIds.has(product.ProductIDFromFile)) {
                    return false;
                }

                const searchFields = [
                    product.ProdName || '',
                    product.tags || '',
                    ...(product.activityTags || []),
                    ...(product.locationTags || [])
                ];

                return searchFields.some(field => 
                    field.toLowerCase().includes(tag.toLowerCase())
                );
            });

            const selectedProducts = matchedProducts.slice(0, maxCount);
            selectedProducts.forEach(product => {
                usedProductIds.add(product.ProductIDFromFile);
            });

            return selectedProducts;
        }

        async function getRecommendedProductIds() {
            if (!currentUserId) {
                console.log('ç„¡ä½¿ç”¨è€… IDï¼Œä½¿ç”¨é è¨­æ¨è–¦');
                return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
            }

            try {
                console.log('å˜—è©¦ä½¿ç”¨å¾Œç«¯æ¨è–¦API...');
                const response = await fetch(`/api/recommend/${currentUserId}`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('å¾å¾Œç«¯APIç²å–æ¨è–¦:', data);
                    if (data.recommendations && data.recommendations.length > 0) {
                        const productIds = data.recommendations.map(item => item.product_id || item.ProductIDFromFile);
                        console.log('å¾Œç«¯æ¨è–¦çš„ç”¢å“ID:', productIds);
                        return productIds;
                    }
                }
            } catch (error) {
                console.warn('å¾Œç«¯æ¨è–¦APIèª¿ç”¨å¤±æ•—ï¼Œä½¿ç”¨å‰ç«¯é‚è¼¯:', error);
            }

            try {
                const userTags = await loadUserTags(currentUserId);
                if (!userTags) {
                    console.log('ä½¿ç”¨è€…æ¨™ç±¤è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­æ¨è–¦');
                    return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
                }

                const recommendedProducts = getRecommendedProductsByTags(userTags, allProducts);
                return recommendedProducts.map(product => product.ProductIDFromFile);
            } catch (error) {
                console.error('ç²å–æ¨è–¦å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return ['3deefa78-833f-48d7-8d7e-69be25234f2d', '0c549d8b-8220-4bc7-b016-b59a7da9448a', 'f0ffa0a5-dea7-40bc-8114-292016eb135e', 'c698b577-e5e6-4334-b710-b276075115f8', '30c042fc-3f7a-4fbb-936c-cc01910f4fa9', '2236ce42-157b-42f5-bed7-570c098f38aa'];
            }
        }

        async function loadRecommendedProducts() {
            try {
                console.log('æ­£åœ¨è¼‰å…¥æ¨è–¦å•†å“...');
                if (currentUserId) {
                    console.log('ä½¿ç”¨è€… ID:', currentUserId);
                }
                
                const recommendedIds = await getRecommendedProductIds();
                console.log('ç²å¾—æ¨è–¦ ID:', recommendedIds);
                
                if (allProducts.length > 0) {
                    const recommendedProducts = getProductsByIds(recommendedIds, allProducts);
                    console.log('æ‰¾åˆ°æ¨è–¦å•†å“:', recommendedProducts.length, 'å€‹');
                    displayRecommendedProducts(recommendedProducts);
                } else {
                    console.warn('allProducts å°šæœªè¼‰å…¥ï¼Œç¨å¾Œé‡è©¦æ¨è–¦å•†å“è¼‰å…¥');
                }
            } catch (error) {
                console.error('è¼‰å…¥æ¨è–¦å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                recommendationGrid.innerHTML = '<p>è¼‰å…¥æ¨è–¦å•†å“æ™‚ç™¼ç”ŸéŒ¯èª¤</p>';
            }
        }

        function sanitizeFilenameComponent(idComponent) {
            if (!idComponent) return `invalid_id_component_${Math.floor(Math.random() * 9000) + 1000}`;
            let safeId = String(idComponent).replace(/[\\/*?:"<>|]/g, "_");
            safeId = safeId.replace(/^\.+|\.+$/g, '').trim();
            return safeId || `invalid_id_component_${Math.floor(Math.random() * 9000) + 1000}`;
        }

        function displayProducts(productsToShow) {
            productGrid.innerHTML = '';
            if (!productsToShow || productsToShow.length === 0) {
                productGrid.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¡Œç¨‹ã€‚</p>';
                return;
            }
            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');

                const productLink = document.createElement('a');
                productLink.href = product.referer || '#';
                productLink.target = '_blank';

                const productImg = document.createElement('img');
                const safeProductId = sanitizeFilenameComponent(product.ProductIDFromFile);
                const imageUrl = `${imageDir}${safeProductId}.jpg`;
                productImg.src = imageUrl;
                productImg.alt = product.ProdName;
                productImg.onerror = function() {
                    this.src = defaultImage;
                    console.warn(`ç„¡æ³•è¼‰å…¥åœ–ç‰‡: ${imageUrl} (åŸºæ–¼product_id ${product.ProductIDFromFile}), ä½¿ç”¨é è¨­åœ–ç‰‡ã€‚`);
                };

                const productTitle = document.createElement('h2');
                productTitle.textContent = product.ProdName;

                const bottomRowContainer = document.createElement('div');
                bottomRowContainer.classList.add('product-bottom-row');

                const tagsContainer = document.createElement('div');
                tagsContainer.classList.add('product-tags');

                if (product.activityTags && Array.isArray(product.activityTags) && product.activityTags.length > 0) {
                    const activityRow = document.createElement('div');
                    activityRow.classList.add('tag-row');
                    
                    product.activityTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'activity-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        activityRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(activityRow);
                }

                if (product.locationTags && Array.isArray(product.locationTags) && product.locationTags.length > 0) {
                    const locationRow = document.createElement('div');
                    locationRow.classList.add('tag-row');
                    
                    product.locationTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'location-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        locationRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(locationRow);
                }
                bottomRowContainer.appendChild(tagsContainer);

                const productPrice = document.createElement('p');
                productPrice.classList.add('price');
                const price = typeof product.ProdPrice === 'number' ? product.ProdPrice.toLocaleString() : 'priceæœªçŸ¥';
                productPrice.textContent = `NT$ ${price} èµ·`;
                bottomRowContainer.appendChild(productPrice);

                productLink.appendChild(productImg);
                productLink.appendChild(productTitle);
                productLink.appendChild(bottomRowContainer); 
                productCard.appendChild(productLink);
                productGrid.appendChild(productCard);
            });
        }

        function updatePagination(totalItems) {
            totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 0) totalPages = 1; 
            pageInfo.textContent = `é  ${currentPage} / ${totalPages}`;

            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalItems === 0;
        }

        function renderPage(pageNumber) {
            currentPage = pageNumber;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = currentProductList.slice(startIndex, endIndex);

            displayProducts(paginatedItems);
            updatePagination(currentProductList.length);
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const sortBy = sortBySelect.value;
            const selectedDestination = destinationSelect.value; 
            const selectedPriceRange = priceRangeSelect.value; 

            let filteredProducts = allProducts.filter(product => {
                let searchMatch = false;
                if (searchTerm) {
                    const nameMatch = product.ProdName && product.ProdName.toLowerCase().includes(searchTerm);
                    const activityMatch = product.activityType && product.activityType.toLowerCase().includes(searchTerm);
                    const locationMatch = product.locationAttraction && product.locationAttraction.toLowerCase().includes(searchTerm);
                    const tagMatch = product.tags && product.tags.toLowerCase().includes(searchTerm);
                    const activityTagsMatch = product.activityTags && product.activityTags.some(tag => 
                        tag.toLowerCase().includes(searchTerm)
                    );
                    const locationTagsMatch = product.locationTags && product.locationTags.some(tag => 
                        tag.toLowerCase().includes(searchTerm)
                    );
                    searchMatch = nameMatch || activityMatch || locationMatch || tagMatch || activityTagsMatch || locationTagsMatch;
                } else {
                    searchMatch = true;
                }

                const destinationMatch = !selectedDestination || 
                    (product.ProdName && product.ProdName.toLowerCase().includes(selectedDestination.toLowerCase())) || 
                    (product.locationAttraction && product.locationAttraction.toLowerCase().includes(selectedDestination.toLowerCase())) ||
                    (product.locationTags && product.locationTags.some(tag => 
                        tag.toLowerCase().includes(selectedDestination.toLowerCase())
                    ));
                
                const price = product.ProdPrice || 0; 
                let priceMatch = true; 
                if (selectedPriceRange) {
                    if (selectedPriceRange === '0-50000') {
                        priceMatch = price >= 0 && price <= 50000;
                    } else if (selectedPriceRange === '50000-100000') {
                        priceMatch = price > 50000 && price <= 100000;
                    } else if (selectedPriceRange === '100000-') {
                        priceMatch = price > 100000;
                    }
                }
                return searchMatch && destinationMatch && priceMatch; 
            });

            let sortedProducts = [...filteredProducts]; 
            switch (sortBy) {
                case 'price-asc':
                    sortedProducts.sort((a, b) => (a.ProdPrice || 0) - (b.ProdPrice || 0));
                    break;
                case 'price-desc':
                    sortedProducts.sort((a, b) => (b.ProdPrice || 0) - (a.ProdPrice || 0));
                    break;
                case 'default':
                default:
                    break;
            }

            currentProductList = sortedProducts; 
            renderPage(1); 
        }

        function parseCSVLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim());
            return result;
        }

        function getProductsByIds(productIds, productList) {
            return productIds.map(id => {
                return productList.find(product => product.ProductIDFromFile === id);
            }).filter(product => product !== undefined);
        }

        function displayRecommendedProducts(products) {
            recommendationGrid.innerHTML = '';
            if (!products || products.length === 0) {
                recommendationGrid.innerHTML = '<p>æš«ç„¡æ¨è–¦å•†å“</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card', 'recommended-card');

                const productLink = document.createElement('a');
                productLink.href = product.referer || '#';
                productLink.target = '_blank';

                const productImg = document.createElement('img');
                const safeProductId = sanitizeFilenameComponent(product.ProductIDFromFile);
                const imageUrl = `${imageDir}${safeProductId}.jpg`;
                productImg.src = imageUrl;
                productImg.alt = product.ProdName;
                productImg.onerror = function() {
                    this.src = defaultImage;
                    console.warn(`ç„¡æ³•è¼‰å…¥åœ–ç‰‡: ${imageUrl} (åŸºæ–¼product_id ${product.ProductIDFromFile}), ä½¿ç”¨é è¨­åœ–ç‰‡ã€‚`);
                };

                const productTitle = document.createElement('h2');
                productTitle.textContent = product.ProdName;

                const bottomRowContainer = document.createElement('div');
                bottomRowContainer.classList.add('product-bottom-row');

                const tagsContainer = document.createElement('div');
                tagsContainer.classList.add('product-tags');

                if (product.activityTags && Array.isArray(product.activityTags) && product.activityTags.length > 0) {
                    const activityRow = document.createElement('div');
                    activityRow.classList.add('tag-row');
                    
                    product.activityTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'activity-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        activityRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(activityRow);
                }

                if (product.locationTags && Array.isArray(product.locationTags) && product.locationTags.length > 0) {
                    const locationRow = document.createElement('div');
                    locationRow.classList.add('tag-row');
                    
                    product.locationTags.forEach(tagText => {
                        const tagElement = document.createElement('span');
                        tagElement.classList.add('tag-button', 'location-tag');
                        tagElement.textContent = tagText;
                        tagElement.addEventListener('click', function(event) {
                            event.preventDefault();
                            event.stopPropagation();
                            searchInput.value = this.textContent;
                            applyFiltersAndSort();
                            searchInput.focus();
                            if (currentUserId) {
                                updateUserTagWeight(this.textContent);
                            }
                        });
                        locationRow.appendChild(tagElement);
                    });
                    tagsContainer.appendChild(locationRow);
                }
                bottomRowContainer.appendChild(tagsContainer);

                const productPrice = document.createElement('p');
                productPrice.classList.add('price');
                const price = typeof product.ProdPrice === 'number' ? product.ProdPrice.toLocaleString() : 'priceæœªçŸ¥';
                productPrice.textContent = `NT$ ${price} èµ·`;
                bottomRowContainer.appendChild(productPrice);

                productLink.appendChild(productImg);
                productLink.appendChild(productTitle);
                productLink.appendChild(bottomRowContainer); 
                productCard.appendChild(productLink);
                recommendationGrid.appendChild(productCard);
            });
        }

        fetch('../data/products.csv')
            .then(response => {
                if (!response.ok) {
                    console.error('Fetch response not OK:', response);
                    throw new Error(`HTTP error! status: ${response.status}. Could not fetch CSV.`);
                }
                return response.text(); 
            })
            .then(csvText => {
                const productMap = new Map();
                const lines = csvText.trim().split(/\r\n|\n/); 

                if (lines.length < 2) {
                    console.warn('CSV file is empty or has no data rows.');
                    allProducts = [];
                    currentProductList = [];
                    renderPage(1);
                    return;
                }

                const headers = parseCSVLine(lines[0]);
                const prodNameIndex = headers.indexOf('product_name');
                const prodPriceIndex = headers.indexOf('price');
                const productIdCsvIndex = headers.indexOf('product_id');
                const activityTagsIndex = headers.indexOf('activity_tags');
                const locationTagsIndex = headers.indexOf('location_tags');

                if (prodNameIndex === -1 || prodPriceIndex === -1 || productIdCsvIndex === -1) {
                    console.error('Required columns (product_name, price, product_id) not found in CSV headers. Found headers:', headers);
                    productGrid.innerHTML = `<p>CSV æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç¼ºå°‘å¿…è¦çš„æ¬„ä½è¡¨é ­ (product_name, price, product_id)ã€‚</p>`;
                    return;
                }
                if (activityTagsIndex === -1) console.warn("CSV header 'activity_tags' not found. Activity tag functionality might be limited.");
                if (locationTagsIndex === -1) console.warn("CSV header 'location_tags' not found. Location tag functionality might be limited.");

                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue; 
                    const cells = parseCSVLine(lines[i]);

                    if (cells.length < headers.length) {
                        console.warn(`Skipping malformed CSV line ${i+1}: ${lines[i]}`);
                        continue;
                    }

                    const prodName = cells[prodNameIndex];
                    const prodPriceStr = cells[prodPriceIndex];
                    const productIdFromFile = cells[productIdCsvIndex];
                    
                    const activityTags = activityTagsIndex !== -1 ? (cells[activityTagsIndex] || '') : '';
                    const locationTags = locationTagsIndex !== -1 ? (cells[locationTagsIndex] || '') : '';
                    
                    const activityTagsArray = activityTags ? activityTags.split(';').map(tag => tag.trim()).filter(tag => tag) : [];
                    const locationTagsArray = locationTags ? locationTags.split(';').map(tag => tag.trim()).filter(tag => tag) : [];
                    
                    const displayActivityTags = activityTagsArray.slice(0, 4);
                    const displayLocationTags = locationTagsArray.slice(0, 4);
                    
                    const allTagsForSearch = [...activityTagsArray, ...locationTagsArray].join(', ');

                    const prodPrice = parseFloat(prodPriceStr);

                    if (prodName &&
                        prodName.length >= 15 && 
                        !isNaN(prodPrice) &&     
                        prodPrice !== undefined &&
                        productIdFromFile && 
                        !productMap.has(prodName)) { 
                        productMap.set(prodName, {
                            ProductIDFromFile: productIdFromFile,
                            ProdName: prodName,
                            ProdPrice: prodPrice,
                            referer: '#',
                            tags: allTagsForSearch,
                            activityTags: displayActivityTags,
                            locationTags: displayLocationTags,
                            activityType: '',
                            locationAttraction: ''
                        });
                    }
                }

                allProducts = Array.from(productMap.values());
                currentProductList = [...allProducts];

                renderPage(1);

                const urlUserId = getUserIdFromUrl();
                if (urlUserId) {
                    currentUserId = urlUserId;
                    console.log('å¾ URL ç²å–ä½¿ç”¨è€… ID:', currentUserId);
                    const userIdInput = document.getElementById('userIdInput');
                    if (userIdInput) {
                        userIdInput.value = currentUserId;
                    }
                }

                loadRecommendedProducts();

                searchInput.addEventListener('input', applyFiltersAndSort);
                sortBySelect.addEventListener('change', applyFiltersAndSort);
                destinationSelect.addEventListener('change', applyFiltersAndSort);
                priceRangeSelect.addEventListener('change', applyFiltersAndSort);

                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        renderPage(currentPage - 1);
                    }
                });

                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        renderPage(currentPage + 1);
                    }
                });
            })
            .catch(error => {
                console.error('Error loading or processing products from CSV:', error);
                productGrid.innerHTML = `<p>è¼‰å…¥è¡Œç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ CSV æª”æ¡ˆæ˜¯å¦å­˜åœ¨æˆ–æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚</p>`;
                prevButton.disabled = true;
                nextButton.disabled = true;
                pageInfo.textContent = 'éŒ¯èª¤';
            });

        function handleLogin() {
            const userIdInput = document.getElementById('userIdInput');
            const userId = userIdInput.value.trim();
            
            if (!userId) {
                alert('è«‹è¼¸å…¥ User ID');
                return;
            }
            
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(userId)) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ User ID æ ¼å¼');
                return;
            }
            
            currentUserId = userId;
            console.log('ç™»å…¥æˆåŠŸï¼Œä½¿ç”¨è€… ID:', currentUserId);
            
            loadRecommendedProducts();
            
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('user_id', userId);
            window.history.pushState({}, '', newUrl);
            
            alert('ç™»å…¥æˆåŠŸï¼æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥å€‹äººåŒ–æ¨è–¦å•†å“...');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const userIdInput = document.getElementById('userIdInput');
            if (userIdInput) {
                userIdInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        handleLogin();
                    }
                });
            }
        });
    </script>
</body>
</html>